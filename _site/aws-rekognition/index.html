<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="icon" href="/assets/images/favicon.png">

<title>Face and Emotion Recognition using R | Malter Analytics</title>

<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Face and Emotion Recognition using R | Analytics and Data Science Blog</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Face and Emotion Recognition using R" />
<meta name="author" content="danny" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This post will demonstrate how to use the AWS Rekognition API with R to detect faces of new images as well as to attribute emotions to a given face. In order to do this, I use the paws R package to interact with AWS. The output image will label a new, unseen image with the name of the individual as well as the emotions tied to the face for that image. A video of this tutorial can be seen here or below." />
<meta property="og:description" content="This post will demonstrate how to use the AWS Rekognition API with R to detect faces of new images as well as to attribute emotions to a given face. In order to do this, I use the paws R package to interact with AWS. The output image will label a new, unseen image with the name of the individual as well as the emotions tied to the face for that image. A video of this tutorial can be seen here or below." />
<link rel="canonical" href="http://localhost:4000/aws-rekognition/" />
<meta property="og:url" content="http://localhost:4000/aws-rekognition/" />
<meta property="og:site_name" content="Analytics and Data Science Blog" />
<meta property="og:image" content="https://github.com/malteranalytics/malteranalytics.github.io/blob/master/assets/images/2020-04-27-aws-rekognition/face_recognition_thumbnail.png?raw=true" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-04-27T00:00:00-05:00" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"danny"},"@type":"BlogPosting","description":"This post will demonstrate how to use the AWS Rekognition API with R to detect faces of new images as well as to attribute emotions to a given face. In order to do this, I use the paws R package to interact with AWS. The output image will label a new, unseen image with the name of the individual as well as the emotions tied to the face for that image. A video of this tutorial can be seen here or below.","image":"https://github.com/malteranalytics/malteranalytics.github.io/blob/master/assets/images/2020-04-27-aws-rekognition/face_recognition_thumbnail.png?raw=true","headline":"Face and Emotion Recognition using R","dateModified":"2020-04-27T00:00:00-05:00","datePublished":"2020-04-27T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/aws-rekognition/"},"url":"http://localhost:4000/aws-rekognition/","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/Malter-Analytics-Logo.png"},"name":"danny"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    
<link href="/assets/css/screen.css" rel="stylesheet">

<link href="/assets/css/main.css" rel="stylesheet">

<script src="/assets/js/jquery.min.js"></script>

</head>




<body class="layout-post">
	<!-- defer loading of font and font awesome -->
	<noscript id="deferred-styles">
		<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	</noscript>


<!-- Begin Menu Navigation
================================================== -->
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down">

    <div class="container pr-0">

    <!-- Begin Logo -->
    <a class="navbar-brand" href="/">
    <img src="/assets/images/Malter-Analytics-Logo.png" alt="Malter Analytics">
    </a>
    <!-- End Logo -->

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarMediumish">

        <!-- Begin Menu -->

            <ul class="navbar-nav ml-auto">

                
                <li class="nav-item">
                
                <a class="nav-link" href="/index.html">Blog</a>
                </li>

                <li class="nav-item">
                <a class="nav-link" href="/about">About</a>
                </li>

                <script src="/assets/js/lunr.js"></script>


<style>
    .lunrsearchresult .title {color: #d9230f;}
    .lunrsearchresult .url {color: silver;}
    .lunrsearchresult a {display: block; color: #777;}
    .lunrsearchresult a:hover, .lunrsearchresult a:focus {text-decoration: none;}
    .lunrsearchresult a:hover .title {text-decoration: underline;}
</style>


</ul>
<form class="bd-search" onsubmit="return lunr_search(document.getElementById('lunrsearch').value);">
    <input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter...">
</form>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="/assets/js/lunrsearchengine.js"></script>

            

        <!-- End Menu -->

    </div>

    </div>
</nav>
<!-- End Navigation
================================================== -->

<div class="site-content">

<div class="container">

<!-- Site Title
================================================== -->
<div class="mainheading">
    <h1 class="sitetitle">Malter Analytics</h1>
    <p class="lead">
        
    </p>
</div>

<!-- Content
================================================== -->
<div class="main-content">
    <!-- Begin Article
================================================== -->
<div class="container">
    <div class="row">

        <!-- Post Share -->
        <div class="col-md-2 pl-0">
            <div class="share">
    <p>
        Share  
        <a target="_blank" href="https://twitter.com/intent/tweet?text=Face%20and%20Emotion%20Recognition%20using%20R&amp;url=http://localhost:4000/aws-rekognition/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" rel="noopener noreferrer">
            <i class="fab fa-twitter"></i>
        </a>  
        <a target="_blank" href="https://facebook.com/sharer.php?u=http://localhost:4000/aws-rekognition/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;" rel="noopener noreferrer">
            <i class="fab fa-facebook-f"></i>
        </a>  
        <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http://localhost:4000/aws-rekognition/" onclick="window.open(this.href, 'width=550,height=435');return false;" rel="noopener noreferrer">
            <i class="fab fa-linkedin-in"></i>
        </a>
    </p>
</div>

        </div>

        <!-- Post -->
        

        <div class="col-md-9 flex-first flex-md-unordered">
            <div class="mainheading">

                <!-- Author Box -->
                
                <div class="row post-top-meta">
                    <div class="col-xs-12 col-md-3 col-lg-2 text-center text-md-left mb-4 mb-md-0">
                        
                        <img class="author-thumb" src="https://www.gravatar.com/avatar/d8f2524cf47fb8fa03ba52ad8579238f?s=250&amp;d=mm&amp;r=x" alt="Danny">
                        
                    </div>
                    <div class="col-xs-12 col-md-9 col-lg-10 text-center text-md-left">
                        <a target="_blank" class="link-dark" href="">Danny</a><a target="_blank" href="https://twitter.com/danmalter" class="btn follow" rel="noopener noreferrer">Follow</a>
                        <span class="author-description">Data Scientist</span>
                    </div>
                </div>
                

                <!-- Post Title -->
                <h1 class="posttitle">Face and Emotion Recognition using R</h1>

            </div>

            <!-- Adsense if enabled from _config.yml (change your pub id and slot) -->
            
            <!-- End Adsense -->

            <!-- Post Featured Image 
            
            

            
            <img class="featured-image img-fluid" src="https://github.com/malteranalytics/malteranalytics.github.io/blob/master/assets/images/2020-04-27-aws-rekognition/face_recognition_thumbnail.png?raw=true" alt="Face and Emotion Recognition using R">
            

            
            End Featured Image -->

            <!-- Post Content -->
            <div class="article-post">
                <!-- Toc if any -->
                
                <!-- End Toc -->
                <p>This post will demonstrate how to use the AWS Rekognition API with R to detect faces of new images as well as to attribute emotions to a given face. In order to do this, I use the <a href="https://paws-r.github.io/" target="_blank" rel="noopener noreferrer">paws</a> R package to interact with AWS. The output image will label a new, unseen image with the name of the individual as well as the emotions tied to the face for that image. A video of this tutorial can be
seen <a href="https://www.youtube.com/watch?v=Dd8aYsye9Qo" target="_blank" rel="noopener noreferrer">here</a> or below.</p>

<iframe width="655" height="405" src="https://www.youtube.com/embed/Dd8aYsye9Qo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<p><br></p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
</pre></td>
<td class="rouge-code"><pre><span class="c1">### AWS Face and Emotion recognition ###</span><span class="w">

</span><span class="n">library</span><span class="p">(</span><span class="n">paws</span><span class="p">)</span><span class="w">  </span><span class="c1"># used for AWS configuration</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">magick</span><span class="p">)</span><span class="w">  </span><span class="c1"># used for image functions</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span><span class="w">

</span><span class="n">aws_access_key_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"################"</span><span class="w">
</span><span class="n">aws_secret_access_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"################"</span><span class="w">

</span><span class="n">svc</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rekognition</span><span class="p">()</span><span class="w">

</span><span class="c1">### Create an AWS collection (server-side containers) ###</span><span class="w">
</span><span class="c1"># Create a library of faces used for determining the identity of a new photo</span><span class="w">

</span><span class="n">svc</span><span class="o">$</span><span class="n">create_collection</span><span class="p">(</span><span class="n">CollectionId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"photos-r"</span><span class="p">)</span><span class="w">
</span><span class="c1">#svc$delete_collection(CollectionId = "photos-r")</span><span class="w">

</span><span class="c1"># photos stored in directory within folders containing the person name</span><span class="w">
</span><span class="c1"># i.e. all "Danny" photos are in folder named "Danny"</span><span class="w">

</span><span class="c1"># Get the list of files</span><span class="w">
</span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"~/Desktop/face_detection/photos"</span><span class="w">
</span><span class="n">filenames</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">list.files</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">recursive</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span><span class="w">

</span><span class="c1"># Loop through the files in the specified folder, add and index them in the collection</span><span class="w">
</span><span class="k">for</span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">filenames</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">imgFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s2">"/"</span><span class="p">)</span><span class="w">
  </span><span class="c1"># Get the person name, which is embedded in the last file path folder name</span><span class="w">
  </span><span class="n">imgName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unlist</span><span class="p">(</span><span class="n">strsplit</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">split</span><span class="o">=</span><span class="s2">"/"</span><span class="p">))[[</span><span class="m">1</span><span class="p">]]</span><span class="w">
  </span><span class="c1"># Add the photos and the name to the AWS collection</span><span class="w">
  </span><span class="n">svc</span><span class="o">$</span><span class="n">index_faces</span><span class="p">(</span><span class="n">CollectionId</span><span class="o">=</span><span class="s2">"photos-r"</span><span class="p">,</span><span class="w"> </span><span class="n">Image</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">Bytes</span><span class="o">=</span><span class="n">imgFile</span><span class="p">),</span><span class="w"> </span><span class="n">ExternalImageId</span><span class="o">=</span><span class="n">imgName</span><span class="p">,</span><span class="w"> </span><span class="n">DetectionAttributes</span><span class="o">=</span><span class="nf">list</span><span class="p">())</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">svc</span><span class="o">$</span><span class="n">list_faces</span><span class="p">(</span><span class="n">CollectionId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"photos-r"</span><span class="p">)</span><span class="w">

</span><span class="c1">### Label and identify the face of a new photo ###</span><span class="w">

</span><span class="c1"># Grab a new photo with multiple faces</span><span class="w">
</span><span class="n">group_photo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"~/Desktop/face_detection/img1.JPG"</span><span class="w">
</span><span class="n">group_file_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unlist</span><span class="p">(</span><span class="n">strsplit</span><span class="p">(</span><span class="n">group_photo</span><span class="p">,</span><span class="n">split</span><span class="o">=</span><span class="s2">"/"</span><span class="p">))[[</span><span class="m">4</span><span class="p">]]</span><span class="w">  </span><span class="c1"># used for writing out annotated file</span><span class="w">

</span><span class="c1"># Read the photo using magick</span><span class="w">
</span><span class="n">img</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">image_read</span><span class="p">(</span><span class="n">group_photo</span><span class="p">)</span><span class="w">

</span><span class="c1"># Get basic info about the photo to be used for annotation</span><span class="w">
</span><span class="n">inf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">image_info</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="w">

</span><span class="c1"># Detect the faces in the image and pull all attributes associated with faces</span><span class="w">
</span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">svc</span><span class="o">$</span><span class="n">detect_faces</span><span class="p">(</span><span class="n">Image</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">Bytes</span><span class="o">=</span><span class="n">group_photo</span><span class="p">),</span><span class="w"> </span><span class="n">Attributes</span><span class="o">=</span><span class="s2">"ALL"</span><span class="p">)</span><span class="w">

</span><span class="c1"># Get the face details</span><span class="w">
</span><span class="n">all_faces</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o</span><span class="o">$</span><span class="n">FaceDetails</span><span class="w">
</span><span class="nf">length</span><span class="p">(</span><span class="n">all_faces</span><span class="p">)</span><span class="w">


</span><span class="c1">### For each face in photo, draw a rectange with the name and emotions ###</span><span class="w">
</span><span class="n">new.img</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">img</span><span class="w">  </span><span class="c1"># Duplicate the original image</span><span class="w">
</span><span class="n">people_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NULL</span><span class="w">

</span><span class="k">for</span><span class="p">(</span><span class="n">face</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">all_faces</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">

  </span><span class="c1"># Grab emotions from AWS rekognition model</span><span class="w">
  </span><span class="n">emo_label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="w">
  </span><span class="k">for</span><span class="p">(</span><span class="n">emo</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">face</span><span class="o">$</span><span class="n">Emotions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">emo_label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="n">emo_label</span><span class="p">,</span><span class="w"> </span><span class="n">emo</span><span class="o">$</span><span class="n">Type</span><span class="p">,</span><span class="w"> </span><span class="s2">" = "</span><span class="p">,</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">emo</span><span class="o">$</span><span class="n">Confidence</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">),</span><span class="w"> </span><span class="s2">"\n"</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="o">=</span><span class="s2">""</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
  
  </span><span class="c1"># Grab ages from AWS rekognition</span><span class="w">
  </span><span class="n">age_label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="w">
  </span><span class="k">for</span><span class="p">(</span><span class="n">age</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">face</span><span class="o">$</span><span class="n">AgeRange</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">age_label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="n">age_label</span><span class="p">,</span><span class="w"> </span><span class="s2">"AGE ESTIMATE: = "</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">age</span><span class="o">$</span><span class="n">Low</span><span class="o">+</span><span class="n">age</span><span class="o">$</span><span class="n">High</span><span class="p">)</span><span class="o">/</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="s2">"\n"</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="o">=</span><span class="s2">""</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
  
  </span><span class="c1"># Grab genders from AWS rekognition</span><span class="w">
  </span><span class="c1">#gender_label = ""</span><span class="w">
  </span><span class="c1">#for(gndr in list(face$Gender)) {</span><span class="w">
  </span><span class="c1">#  gender_label = paste(gender_label, gndr$Value, " = ", round(gndr$Confidence, 2), "\n", sep="")</span><span class="w">
  </span><span class="c1">#}</span><span class="w">
  
  </span><span class="c1"># Append all lists together</span><span class="w">
  </span><span class="n">final_label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="w">
  </span><span class="n">final_label</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">emo_label</span><span class="p">,</span><span class="w"> </span><span class="n">age_label</span><span class="p">)</span><span class="w">
  </span><span class="n">final_label</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="n">final_label</span><span class="p">,</span><span class="w"> </span><span class="n">collapse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="p">)</span><span class="w">
  
  </span><span class="c1"># Identify the coordinates of the face. Note that AWS returns percentage values of the total image size. This is</span><span class="w">
  </span><span class="c1"># why the image info object above is needed</span><span class="w">
  </span><span class="n">box</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">face</span><span class="o">$</span><span class="n">BoundingBox</span><span class="w">
  </span><span class="n">image_width</span><span class="o">=</span><span class="n">inf</span><span class="o">$</span><span class="n">width</span><span class="w">
  </span><span class="n">image_height</span><span class="o">=</span><span class="n">inf</span><span class="o">$</span><span class="n">height</span><span class="w">
  </span><span class="n">x1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">box</span><span class="o">$</span><span class="n">Left</span><span class="o">*</span><span class="n">image_width</span><span class="w">
  </span><span class="n">y1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">box</span><span class="o">$</span><span class="n">Top</span><span class="o">*</span><span class="n">image_height</span><span class="w">
  </span><span class="n">x2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">box</span><span class="o">$</span><span class="n">Width</span><span class="o">*</span><span class="n">image_width</span><span class="w">
  </span><span class="n">y2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">box</span><span class="o">$</span><span class="n">Height</span><span class="o">*</span><span class="n">image_height</span><span class="w">  
  
  </span><span class="c1"># Create a subset image in memory that is just cropped around the focal face</span><span class="w">
  </span><span class="n">img.crop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">image_crop</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="n">box</span><span class="o">$</span><span class="n">Width</span><span class="o">*</span><span class="n">image_width</span><span class="p">,</span><span class="s2">"x"</span><span class="p">,</span><span class="n">box</span><span class="o">$</span><span class="n">Height</span><span class="o">*</span><span class="n">image_height</span><span class="p">,</span><span class="s2">"+"</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="s2">"+"</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="o">=</span><span class="s2">""</span><span class="p">))</span><span class="w">
  </span><span class="n">img.crop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">image_write</span><span class="p">(</span><span class="n">img.crop</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"png"</span><span class="p">)</span><span class="w">
  
  </span><span class="c1"># Search in a specified collection to see if we can label the identity of the face is in this crop</span><span class="w">
  </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">svc</span><span class="o">$</span><span class="n">search_faces_by_image</span><span class="p">(</span><span class="n">CollectionId</span><span class="o">=</span><span class="s2">"photos-r"</span><span class="p">,</span><span class="n">Image</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">Bytes</span><span class="o">=</span><span class="n">img.crop</span><span class="p">),</span><span class="w"> </span><span class="n">FaceMatchThreshold</span><span class="o">=</span><span class="m">70</span><span class="p">)</span><span class="w">
  
  </span><span class="c1"># Create a graphics device version of the larger photo that we can annotate</span><span class="w">
  </span><span class="n">new.img</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">image_draw</span><span class="p">(</span><span class="n">new.img</span><span class="p">)</span><span class="w">
  
  </span><span class="c1"># If the face matches something in the collection, then add the name to the image</span><span class="w">
  </span><span class="k">if</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">o</span><span class="o">$</span><span class="n">FaceMatches</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">faceName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o</span><span class="o">$</span><span class="n">FaceMatches</span><span class="p">[[</span><span class="m">1</span><span class="p">]]</span><span class="o">$</span><span class="n">Face</span><span class="o">$</span><span class="n">ExternalImageId</span><span class="w">
    </span><span class="n">faceConfidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">o</span><span class="o">$</span><span class="n">FaceMatches</span><span class="p">[[</span><span class="m">1</span><span class="p">]]</span><span class="o">$</span><span class="n">Face</span><span class="o">$</span><span class="n">Confidence</span><span class="p">,</span><span class="m">3</span><span class="p">)</span><span class="w">
    </span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s2">"Detected: "</span><span class="p">,</span><span class="w"> </span><span class="n">faceName</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="o">=</span><span class="s2">""</span><span class="p">))</span><span class="w">
    
    </span><span class="c1"># Annotate with the name of the person</span><span class="w">
    </span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x1</span><span class="o">+</span><span class="p">(</span><span class="n">box</span><span class="o">$</span><span class="n">Width</span><span class="o">*</span><span class="n">image_width</span><span class="p">)</span><span class="o">/</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">y1</span><span class="m">-20</span><span class="p">,</span><span class="w"> </span><span class="n">faceName</span><span class="p">,</span><span class="w"> </span><span class="n">adj</span><span class="o">=</span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex</span><span class="o">=</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="o">=</span><span class="s2">"green"</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
  
  </span><span class="c1"># Draw a rectangle around the face</span><span class="w">
  </span><span class="n">rect</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span><span class="w"> </span><span class="n">border</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span><span class="w"> </span><span class="n">lty</span><span class="o">=</span><span class="s2">"dashed"</span><span class="p">,</span><span class="w"> </span><span class="n">lwd</span><span class="o">=</span><span class="m">5</span><span class="p">)</span><span class="w">   
  
  </span><span class="c1"># Annotate the photo with the emotions information</span><span class="w">
  </span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x1</span><span class="o">+</span><span class="p">(</span><span class="n">box</span><span class="o">$</span><span class="n">Width</span><span class="o">*</span><span class="n">image_width</span><span class="p">)</span><span class="o">/</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">y1</span><span class="m">+50</span><span class="p">,</span><span class="w"> </span><span class="n">final_label</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">cex</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="o">=</span><span class="s2">"red"</span><span class="p">)</span><span class="w">     
  
  </span><span class="c1"># Create a dataframe of individual data appended together</span><span class="w">
  </span><span class="n">individual_emotion_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">do.call</span><span class="p">(</span><span class="n">rbind.data.frame</span><span class="p">,</span><span class="w"> </span><span class="n">face</span><span class="o">$</span><span class="n">Emotions</span><span class="p">)</span><span class="w">
  
  </span><span class="n">individual_emotion_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">individual_emotion_df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
    </span><span class="n">spread</span><span class="p">(</span><span class="n">Type</span><span class="p">,</span><span class="w"> </span><span class="n">Confidence</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">add_column</span><span class="p">(</span><span class="n">faceName</span><span class="p">)</span><span class="w">
  </span><span class="n">individual_emotion_df</span><span class="o">$</span><span class="n">image</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">strsplit</span><span class="p">(</span><span class="n">group_file_name</span><span class="p">,</span><span class="w"> </span><span class="s2">".JPG"</span><span class="p">)</span><span class="w">
  
  </span><span class="n">individual_emotion_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">individual_emotion_df</span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">select</span><span class="p">(</span><span class="n">faceName</span><span class="p">,</span><span class="w"> </span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="n">everything</span><span class="p">())</span><span class="w"> </span><span class="c1"># move faceName to beginning</span><span class="w">
  
  </span><span class="n">individual_age_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">face</span><span class="o">$</span><span class="n">AgeRange</span><span class="p">)</span><span class="w">
  </span><span class="n">colnames</span><span class="p">(</span><span class="n">individual_age_df</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"age_low"</span><span class="p">,</span><span class="w"> </span><span class="s2">"age_high"</span><span class="p">)</span><span class="w">
  
  </span><span class="n">individual_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cbind</span><span class="p">(</span><span class="n">individual_emotion_df</span><span class="p">,</span><span class="w"> </span><span class="n">individual_age_df</span><span class="p">)</span><span class="w">
  
  </span><span class="n">people_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">individual_df</span><span class="p">,</span><span class="w"> </span><span class="n">people_df</span><span class="p">)</span><span class="w">
  
</span><span class="p">}</span><span class="w">
</span><span class="n">dev.off</span><span class="p">()</span><span class="w">

</span><span class="n">people_df</span><span class="o">$</span><span class="n">age_est</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">people_df</span><span class="o">$</span><span class="n">age_low</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">people_df</span><span class="o">$</span><span class="n">age_high</span><span class="p">)</span><span class="o">/</span><span class="m">2</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">people_df</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tolower</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">people_df</span><span class="p">))</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">people_df</span><span class="p">)</span><span class="w">

</span><span class="c1"># Write the image out to file </span><span class="w">
</span><span class="n">image_write</span><span class="p">(</span><span class="n">new.img</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="o">=</span><span class="n">paste0</span><span class="p">(</span><span class="s2">"~/Desktop/face_detection/annotated/annotated_"</span><span class="p">,</span><span class="w"> </span><span class="n">group_file_name</span><span class="p">))</span><span class="w">
</span></pre></td>
</tr></tbody></table></code></pre></div></div>

<p>Example table if you want to output the data above into a dataframe.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td>
<td class="rouge-code"><pre>| faceName | image | angry      | calm        | confused   | disgusted   | fear        | happy    | sad         | surprised  |
|----------|-------|------------|-------------|------------|-------------|-------------|----------|-------------|------------|
| Natalie  | img1  | 0.05724448 | 0.008161878 | 0.08076324 | 0.054936308 | 0.048346419 | 99.64977 | 0.037308376 | 0.06347576 |
| Danny    | img1  | 0.01850546 | 0.008797654 | 0.01369155 | 0.005110143 | 0.009048435 | 99.88663 | 0.003529715 | 0.05468611 |
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p><img src="/assets/images/2020-04-27-aws-rekognition/annotated_img1.JPG" alt="face-detection">
<img src="/assets/images/2020-04-27-aws-rekognition/annotated_img2.JPG" alt="face-detection"></p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-57468410-2', 'auto');
  ga('send', 'pageview');

</script>


            </div>

            <!-- Rating -->
            

            <!-- Post Date -->
            <p>
            <small>
                <span class="post-date"><time class="post-date" datetime="2020-04-27">27 Apr 2020</time></span>           
                
                </small>
            </p>

            <!-- Post Categories -->
            <div class="after-post-cats">
                <ul class="tags mb-4">
                    
                    
                    <li>
                        <a class="smoothscroll" href="/categories#AWS">AWS</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/categories#R">R</a>
                    </li>
                    
                </ul>
            </div>
            <!-- End Categories -->

            <!-- Post Tags -->
            <div class="after-post-tags">
                <ul class="tags">
                    
                    
                    <li>
                        <a class="smoothscroll" href="/tags#AWS">#AWS</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/tags#R">#R</a>
                    </li>
                    
                </ul>
            </div>
            <!-- End Tags -->

            <!-- Prev/Next -->
            <div class="row PageNavigation d-flex justify-content-between font-weight-bold">
            
            <a class="prev d-block col-md-6" href="//ww2-strategy/"> « Analysis of the Allies' WWII Strategy</a>
            
            
            <a class="next d-block col-md-6 text-lg-right" href="//mlb-playoff-predictions/">Are 60 Games Enough for MLB Trends to 'Regress to the Mean'? » </a>
            
            <div class="clearfix"></div>
            </div>
            <!-- End Categories -->

        </div>
        <!-- End Post -->

    </div>
</div>
<!-- End Article
================================================== -->

<!-- Begin Comments
================================================== -->

    <div class="container">
        <div id="comments" class="row justify-content-center mb-5">
            <div class="col-md-8">
                <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'danmalter'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript" target="_blank" rel="noopener noreferrer">comments powered by Disqus.</a>
</noscript>
    <a href="http://disqus.com" class="dsq-brlink" target="_blank" rel="noopener noreferrer">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>

            </div>
        </div>
    </div>

<!--End Comments
================================================== -->

<!-- Review with LD-JSON, adapt it for your needs if you like, but make sure you test the generated HTML source code first: 
https://search.google.com/structured-data/testing-tool/u/0/
================================================== -->

</div>

<!-- Bottom Alert Bar
================================================== -->
<div class="alertbar">
	<div class="container text-center">
		<span>Follow me on your preferred social network.</span>  
        
        <a target="_blank" href="http://www.instagram.com/malteranalytics" rel="noopener noreferrer">
            <i class="fab fa-instagram"></i>
        </a>  
        
        
        <a target="_blank" href="http://www.twitter.com/danmalter" rel="noopener noreferrer">
            <i class="fab fa-twitter"></i>
        </a>  
        
        
        <a target="_blank" href="https://www.facebook.com/malteranalytics" rel="noopener noreferrer">
            <i class="fab fa-facebook-f"></i>
        </a>  
        
        
        
        <a target="_blank" href="https://github.com/malteranalytics" rel="noopener noreferrer">
            <i class="fab fa-github"></i>
        </a>
        
        
	</div>
</div>
    
</div>

<!-- Categories Jumbotron
================================================== -->
<div class="jumbotron fortags">
	<div class="d-md-flex h-100">
		<div class="col-md-4 transpdark align-self-center text-center h-100">
            <div class="d-md-flex align-items-center justify-content-center h-100">
                <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span>
</h2>
            </div>
		</div>
		<div class="col-md-8 p-5 align-self-center text-center">
            
            
                
                    <a class="mt-1 mb-1" href="/categories#YOLO">YOLO (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#MLB">MLB (4)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Python">Python (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#NBA">NBA (6)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Clustering">Clustering (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Analytics">Analytics (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#R">R (6)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Baseball">Baseball (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Moneyball">Moneyball (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#NFL">NFL (3)</a>
                
                    <a class="mt-1 mb-1" href="/categories#football">football (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Sports">Sports (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#NHL">NHL (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#ww2">ww2 (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Allies">Allies (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#D-Day">D-Day (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#AWS">AWS (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#mlb">mlb (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#baseball">baseball (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#dataviz">dataviz (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#covid">covid (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#covid19">covid19 (3)</a>
                
                    <a class="mt-1 mb-1" href="/categories#coronavirus">coronavirus (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Basketball">Basketball (4)</a>
                
                    <a class="mt-1 mb-1" href="/categories#UFC">UFC (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#MMA">MMA (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#python">python (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#MarchMadness">MarchMadness (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#basketball">basketball (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#college">college (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Golf">Golf (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Masters">Masters (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#openpose">openpose (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Olympics">Olympics (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Tokyo">Tokyo (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Football">Football (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Paris">Paris (1)</a>
                
            
            
		</div>
	</div>
</div>

<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-6 text-center text-lg-left">
                Copyright © 2024 Malter Analytics
            <div class="col-md-6 col-sm-6 text-center text-lg-right">    
            </div>
        </div>
    </div>

<!-- End Footer
================================================== -->

</div> <!-- /.site-content -->

<!-- Scripts
================================================== -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

<script src="/assets/js/mediumish.js"></script>



<script src="/assets/js/ie10-viewport-bug-workaround.js"></script> 


<script id="dsq-count-scr" src="//danmalter.disqus.com/count.js"></script>


</footer>
</div></body>
</html>
